%% Stack RXX PETHs across days  
%  Create struct w/ avg FR per RXX trialtype and neuron ordering
%  ~Cross-validate~ order by using peaks from other trials

%% Set paths and basic analysis options 

paths = struct;
paths.data = '/Users/joshstern/Documents/UchidaLab_NeuralData/processed_neuropix_data/all_mice';
paths.figs = '/Users/joshstern/Documents/UchidaLab_NeuralData/neural_data_figs'; % where to save figs

addpath(genpath('/Users/joshstern/Documents/UchidaLab_NeuralData'));

% analysis options
opt = struct;
opt.tbin = 0.02; % time bin for whole session rate matrix (in sec) 
tbin_ms = opt.tbin * 1000;
opt.smoothSigma_time = 0.100; % gauss smoothing sigma for rate matrix (in sec) 
opt.preLeave_buffer = 500; 
opt.cortex_only = true;

sessions = dir(fullfile(paths.data,'*.mat'));
sessions = {sessions.name}; 

%% Extract FR matrices and timing information 
FR_decVar = struct; 
for sIdx = 23:25
    FR_decVar_tmp = genSeqStructs(paths,sessions,opt,sIdx);
    % assign to sIdx
    FR_decVar(sIdx).fr_mat = FR_decVar_tmp.fr_mat; 
    FR_decVar(sIdx).goodcell_IDs = FR_decVar_tmp.goodcell_IDs; 
    FR_decVar(sIdx).decVarTime = FR_decVar_tmp.decVarTime;
    FR_decVar(sIdx).decVarTimeSinceRew = FR_decVar_tmp.decVarTimeSinceRew; 
    FR_decVar(sIdx).cell_depths = FR_decVar_tmp.spike_depths;
end  

%% Generate "reward barcodes" to average firing rates  
rew_barcodes = cell(numel(sessions),1);
for sIdx = 23:25
    session = sessions{sIdx}(1:end-4);
    data = load(fullfile(paths.data,session)); 
    
    % reinitialize ms vectors
    patchstop_ms = data.patchCSL(:,2);
    patchleave_ms = data.patchCSL(:,3);
    rew_ms = data.rew_ts;
    
    sec1ix = 1000/tbin_ms;
    sec2ix = 2000/tbin_ms;
    times = -1000:tbin_ms:1000;
    
    % Trial level features
    patches = data.patches;
    patchCSL = data.patchCSL;
    prts = patchCSL(:,3) - patchCSL(:,2);
    floor_prts = floor(prts);
    rewsize = mod(patches(:,2),10);
    
    % make barcode matrices
    nTimesteps = 15;
    rew_barcode = zeros(length(patchCSL) , nTimesteps);
    for iTrial = 1:length(patchCSL)
        rew_indices = round(rew_ms(rew_ms >= patchstop_ms(iTrial) & rew_ms < patchleave_ms(iTrial)) - patchstop_ms(iTrial)) + 1;
        rew_barcode(iTrial , (floor_prts(iTrial) + 1):end) = -1; % set part of patch after leave = -1
        rew_barcode(iTrial , rew_indices) = rewsize(iTrial);
    end 
    rew_barcodes{sIdx} = rew_barcode;
end 

%% Generate cross-days cell array with RXX averages and peak indices per day  
% column 1:: trial types: 100, 110, 101, 111, etc... 
% column 2:: avg PETHs, peak indices (from unvisualized trials) 
% column 3:: sessions
RXX_data = cell(12,2,numel(sessions)); 
for sIdx = 23:25 
    session = sessions{sIdx}(1:end-4);
    data = load(fullfile(paths.data,session));
    prts = data.patchCSL(:,3) - data.patchCSL(:,2);  
    nTrials = length(prts);
    
    % reinitialize ms vectors
    rew_barcode = rew_barcodes{sIdx};  
    sec3ix = 3000 / tbin_ms;
  
    rew_counter = 1;

    opt = struct;
    opt.dvar = "timesince";
    opt.decVar_bins = linspace(0,2,41); 
    opt.sort = false; % don't sort yet... just get the peak indices
    for iRewsize = [1,2,4] 
        trials100x = find(rew_barcode(:,1) == iRewsize & rew_barcode(:,2) == 0 & rew_barcode(:,3) == 0 & prts > 3.5);
        trials110x = find(rew_barcode(:,1) == iRewsize & rew_barcode(:,2) == iRewsize & rew_barcode(:,3) == 0 & prts > 3.5);
        trials101x = find(rew_barcode(:,1) == iRewsize & rew_barcode(:,2) == 0 & rew_barcode(:,3) == iRewsize & prts > 3.5);
        trials111x = find(rew_barcode(:,1) == iRewsize & rew_barcode(:,2) == iRewsize & rew_barcode(:,3) == iRewsize & prts > 3.5);
        
        [RXX_data{rew_counter,1,sIdx},RXX_data{rew_counter,2,sIdx}] = avgPETH(FR_decVar(sIdx),trials100x,setdiff(1:nTrials,trials100x),sec3ix,opt);
        [RXX_data{rew_counter+1,1,sIdx},RXX_data{rew_counter+1,2,sIdx}] = avgPETH(FR_decVar(sIdx),trials110x,setdiff(1:nTrials,trials110x),sec3ix,opt);
        [RXX_data{rew_counter+2,1,sIdx},RXX_data{rew_counter+2,2,sIdx}] = avgPETH(FR_decVar(sIdx),trials101x,setdiff(1:nTrials,trials101x),sec3ix,opt);
        [RXX_data{rew_counter+3,1,sIdx},RXX_data{rew_counter+3,2,sIdx}] = avgPETH(FR_decVar(sIdx),trials111x,setdiff(1:nTrials,trials111x),sec3ix,opt);
        
        rew_counter = rew_counter + 4;
    end
end 

%% Now visualize PETH across days with cross validated sort  

concat_days = {[23 25],(23:25)}; 
for iSessions = 2
    these_sessions = concat_days{iSessions};
    for cond = 1:12 
        cond_frmat_cell = squeeze(RXX_data(cond,1,these_sessions));
        cond_frmat = cat(1,a{:}); 
        cond_frmat_sorted = cond_frmat

    end 
end
